name: 1. Validate Secrets
run-name: Validate Secrets (${{ github.ref_name }})
on: [workflow_call, workflow_dispatch]

jobs:
  validate-fastlane-secrets:
    name: Fastlane
    runs-on: macos-14
    env:
      GH_PAT: ${{ secrets.GH_PAT }}
      GH_TOKEN: ${{ secrets.GH_PAT }}
      FASTLANE_ISSUER_ID: ${{ secrets.FASTLANE_ISSUER_ID }}
      FASTLANE_KEY_ID: ${{ secrets.FASTLANE_KEY_ID }}
      FASTLANE_KEY: ${{ secrets.FASTLANE_KEY }}
      MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
      TEAMID: ${{ secrets.TEAMID }}
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      # Uninstall any existing Bundler versions
      - name: Uninstall existing Bundler
        run: gem uninstall bundler -a -x || true
  
      # Install Bundler 2.4.19
      - name: Install Bundler 2.4.19
        run: gem install bundler -v 2.4.19
  
      # Verify Bundler version
      - name: Verify Bundler version
        run: bundler -v
  
      # Remove Gemfile.lock if necessary
      - name: Remove Gemfile.lock if exists
        run: |
          if [ -f Gemfile.lock ]; then
            echo "Removing existing Gemfile.lock"
            rm -f Gemfile.lock
          else
            echo "No Gemfile.lock to remove"
          fi
  
      # Install project dependencies using Bundler 2.4.19
      - name: Install Project Dependencies
        run: bundle _2.4.19_ install

      # Validate Fastlane Secrets
      - name: Validate Fastlane Secrets
        run: bundle exec fastlane validate_secrets
