name: Build and Upload to TestFlight

on:
  workflow_dispatch:  # Manual trigger only for safety
    inputs:
      build_type:
        description: 'Build Type'
        required: true
        default: 'development'
        type: choice
        options:
        - development
        - release

jobs:
  build-and-upload:
    name: Build and Upload to TestFlight
    runs-on: macos-latest
    
    # Only run if required secrets are available
    if: |
      secrets.TEAMID != '' &&
      secrets.FASTLANE_KEY_ID != '' &&
      secrets.FASTLANE_ISSUER_ID != '' &&
      secrets.FASTLANE_KEY != ''
      
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: Select Xcode
      run: sudo xcode-select -s /Applications/Xcode.app
      
    - name: Install Fastlane
      run: |
        gem install bundler
        bundle install
        
    - name: Setup Provisioning
      env:
        TEAMID: ${{ secrets.TEAMID }}
        FASTLANE_KEY_ID: ${{ secrets.FASTLANE_KEY_ID }}
        FASTLANE_ISSUER_ID: ${{ secrets.FASTLANE_ISSUER_ID }}
        FASTLANE_KEY: ${{ secrets.FASTLANE_KEY }}
        GH_PAT: ${{ secrets.GH_PAT }}
      run: |
        bundle exec fastlane setup
        
    - name: Build and Upload
      env:
        TEAMID: ${{ secrets.TEAMID }}
        FASTLANE_KEY_ID: ${{ secrets.FASTLANE_KEY_ID }}
        FASTLANE_ISSUER_ID: ${{ secrets.FASTLANE_ISSUER_ID }}
        FASTLANE_KEY: ${{ secrets.FASTLANE_KEY }}
        BUILD_TYPE: ${{ github.event.inputs.build_type }}
      run: |
        if [ "$BUILD_TYPE" = "release" ]; then
          bundle exec fastlane release
        else
          bundle exec fastlane beta
        fi
        
    - name: Upload IPA
      uses: actions/upload-artifact@v3
      with:
        name: loop-ipa
        path: |
          Loop.ipa
          ExportOptions.plist
        
    - name: Upload Build Logs
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: build-logs
        path: buildlog/